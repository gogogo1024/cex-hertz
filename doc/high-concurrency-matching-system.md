
# 超高并发撮合系统架构设计文档

## 一、系统架构总览

本系统旨在支持超过1000万级并发订阅者的撮合服务，具备高吞吐、高可靠、低延迟的特点。

### 架构图（简化描述）
```
+------------+     +------------------+     +---------------+
|  前端页面  | <-> |   WebSocket 网关   | <-> |  撮合服务集群  |
+------------+     +------------------+     +-------+-------+
                                              |
                                      +-------v-------+
                                      |   Kafka 总线   |
                                      +-------+-------+
                                              |
                                     +--------v--------+
                                     | PostgreSQL + Redis |
                                     +-------------------+
```

## 二、模块一：WebSocket 网关（支持频道机制）

### 1. 功能说明

- 基于 `CloudWeGo Netpoll` 提供高性能连接复用。
- 每个币种一个房间频道。
- 支持订阅、取消订阅、广播成交等消息类型。
- 心跳机制保证连接有效。

### 2. 数据结构

- `Client`：代表一个连接，包含 `Conn`、`SubscribedChannels`。
- `Hub`：管理所有频道、连接和广播逻辑。
- `Message`：支持 JSON 格式，包括类型、频道、数据字段。

### 3. 性能优化

- Goroutine 池（使用 `ants` 或 `go-pool`）。
- 零拷贝数据结构（bytes.Buffer / sync.Pool）。
- epoll + 多路复用（CloudWeGo Netpoll）。

## 三、模块二：撮合引擎（支持传入交易对）

### 1. 功能说明

- 接收订单（买/卖）并写入队列。
- 撮合匹配逻辑根据交易对、价格优先、时间优先。
- 撮合结果通过 Kafka 推送。

### 2. 数据结构

- `Order`：包含交易对、方向、数量、价格、时间戳。
- `OrderBook`：每个交易对一个，维护买卖队列。
- `Engine`：多交易对管理、撮合执行。

### 3. 性能优化

- 分交易对并发撮合（多核并行）。
- 使用堆或跳表维护价格队列。
- 写入结果异步推送 Kafka。

## 四、模块三：前端下单 + 实时成交订阅页面（React）

### 1. 技术栈

- React + shadcn/ui
- Zustand 管理订阅状态
- 原生 WebSocket 客户端

### 2. 页面结构

- 下单表单（选择币种、方向、价格、数量）。
- 实时成交表（表格形式展示某币种的最新成交）。

### 3. 交互流程

1. 页面加载后连接 WebSocket 并订阅某币种。
2. 用户提交订单，通过 REST API 发送后端。
3. 成交结果通过 WebSocket 实时推送更新页面。

## 五、十四、压力测试结论（模拟）

### 1. 目标

- 模拟 1000万 并发连接。
- 单机性能压测网关服务和撮合服务。

### 2. 方法

- 使用 `wrk` + 自定义 WebSocket 客户端模拟。
- CloudWeGo Netpoll 支持每核百万连接，通过扩容横向伸缩。

### 3. 模拟结论（预估）

- 1 台 32C64G 服务器可承载 ~200-300 万连接。
- 撮合服务具备每秒百万级撮合能力（视交易对复杂度）。
- 使用 Redis 和 Kafka 实现异步写入 + 解耦通信。

---

**推荐部署方式：**

- WebSocket 网关与撮合引擎分离部署。
- Kafka 实现撮合与广播解耦。
- Redis 保证状态数据快速访问。
- 使用 Kubernetes 弹性扩容。
