# 分区（Partition）与 Worker（撮合引擎节点）关系说明

## 概念定义

- **分区（Partition）**：撮合系统中负责一组 symbol（交易对）撮合任务的逻辑单元。每个分区有自己的唯一 ID、负责的 symbol 列表（Symbols），以及分配给它的 worker 列表（Workers）。
- **Worker（撮合引擎节点）**：实际运行撮合引擎的服务实例（如进程或容器），负责处理分配给它的分区中的 symbol 的撮合请求。每个 worker 可以负责一个或多个分区。

## 对应关系

- 一个分区可以分配给一个或多个 worker（通常用于高可用、主备、负载均衡等场景）。
- 一个 worker 可以同时负责多个分区（提升资源利用率和弹性）。
- 分区和 worker 之间是多对多的灵活分配关系。

## 举例

- PartitionA：Symbols = [BTCUSDT, ETHUSDT]，Workers = [worker1]
- PartitionB：Symbols = [DOGEUSDT]，Workers = [worker2]
- worker1 负责 PartitionA，worker2 负责 PartitionB

## 设计优势

- 支持弹性扩缩容：可根据业务压力动态调整分区与 worker 的分配关系。
- 支持高可用：同一分区可分配给多个 worker，实现主备或多活。
- 支持负载均衡：新分区可优先分配给空闲 worker，提升整体资源利用率。

## 典型应用场景

- 热点 symbol 拆分：将高负载 symbol 独立为新分区，分配到新 worker。
- 冷门 symbol 合并：将低负载 symbol 合并到同一分区，减少资源浪费。
- 分区迁移：支持分区在 worker 之间灵活迁移，保证系统弹性和高可用。

## 分区扩缩容与消息处理（对标 Redis 迁移机制）

在分区（Partition）扩缩容、迁移过程中，系统需保证 symbol 的撮合消息不丢失、顺序性可控、业务不中断。参照 Redis 集群的数据迁移机制，撮合系统的消息处理建议如下：

### 1. 迁移阶段的多对多映射
- 分区扩缩容或迁移时，`SymbolToPartition` 支持 symbol 到多个分区的多对多映射。
- 迁移期间，同一个 symbol 可能同时属于旧分区和新分区，实现新旧分区并行。

### 2. 消息处理策略
- **新旧分区并行**：迁移开始后，symbol 的撮合请求可路由到新旧分区，或采用灰度切流、双写等方式，保证新分区补齐历史数据。
- **消息同步/补偿**：旧分区需将未完成订单、撮合消息同步到新分区，确保新分区数据完整。
- **顺序与幂等**：每条撮合消息应有唯一ID，分区间同步时可去重，顺序性可通过全局队列、分布式锁或业务容忍短暂乱序实现。

### 3. 切流与收敛
- **灰度切流**：逐步将 symbol 的撮合流量切到新分区，旧分区只处理历史未完成订单。
- **最终收敛**：确认新分区已完全接管 symbol 后，`SymbolToPartition` 只保留新分区，旧分区下线。

### 4. 设计优势
- 支持平滑迁移、弹性扩缩容和高可用。
- 迁移期间业务不中断，消息无丢失。
- 便于实现主备、灰度、AB测试等复杂场景。

---

本机制借鉴了 Redis 等分布式系统的数据迁移原理，适用于高并发撮合系统的分区弹性和高可用设���。
