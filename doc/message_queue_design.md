# 消息队列核心机制设计要求

本设计要求文档总结了在高并发交易系统中，消息队列（如 Kafka、RabbitMQ、RocketMQ 等）应具备的核心机制和设计要点。

## 1. 消息模型
- 支持点对点（Queue）和发布订阅（Topic）两种基本模型。
- 允许多生产者、多消费者并发写入和读取。

## 2. 传递保障
- 至少一次（At-least-once）：保证消息不会丢失，可能会重复。
- 仅一次（Exactly-once）：保证消息既不丢失也不重复（部分队列支持）。
- 至多一次（At-most-once）：消息可能丢失但绝不重复。
- 需根据业务场景选择合适的保障级别。

## 3. 高吞吐量设计
- 支持批量写入、批量消费，提升消息处理效率。
- 分区（Partition）机制，允许多线程并行处理。
- 零拷贝、顺序写盘等底层优化。

## 4. 高可用性策略
- 多副本（Replica）机制，主从切换自动容灾。
- Broker 节点自动发现与故障转移。
- 消息持久化，防止单点故障导致数据丢失。

## 5. 消息一致性
- 顺序一致性：同一分区内消息严格有序。
- 跨分区全局顺序需业务端保证。
- 事务消息：支持生产者端的多消息原子写入，保证业务一致性。

## 6. 顺序消息
- 通过分区键（Key）保证同一业务主键的消息顺序。
- 消费端需按分区顺序消费，避免乱序。

## 7. 延迟消息
- 支持定时投递、延迟队列等功能，满足业务定时触发需求。

## 8. 事务消息
- 支持消息的预提交、确认提交、回滚等事务操作。
- 适用于订单、支付等强一致性场景。

## 9. 监控与告警
- 实时监控消息堆积、消费延迟、失败重试等指标。
- 支持自动告警和自愈机制。

## 10. 其他要求
- 易于扩展，支持水平扩容。
- 提供完善的 API 和 SDK，便于业务集成。
- 支持多语言客户端。

## 动态分区扩展设计与实现

### 1. 分区元数据管理
- 采用中心化存储（如数据库或配置中心）维护 symbol 与分区的映射关系。
- 每次分区变更（扩展/收缩/迁移）时，更新元数据，所有服务节点可感知变更。

### 2. 路由与分区感知
- 路由层根据最新分区元数据，将消息路由到对应分区。
- Worker 节点支持热加载分区配置，自动订阅/退订分区。

### 3. 分区扩展与收缩流程
- 监控分区负载，自动触发分区扩展或收缩。
- 扩展时为热点 symbol 拆分新分区，收缩时合并冷门 symbol。
- 分区迁移期间，保证消息顺序和一致性，采用“新旧分区并行+流量逐步切换”策略。
- 自动扩缩容调度
   - 关注点：何时扩容、何时缩容、如何自动调整分区数量和分布。
   - 主要职责：监控分区负载（如 QPS、延迟、堆积等），根据策略自动决定是否需要扩展/收缩分区，并自动修改分区表（如为热点 symbol 拆分新分区，合并冷门分区）。
   - 触发时机：通常是定时任务或实时监控触发。
   - 结果：分区表发生变更，worker 感知到新分区分配。
- 分区迁移流量切换
   - 关注点：分区表变更后，如何平滑地将流量从旧分区切换到新分区，保证业务不中断、顺序和一致性。
   - 主要职责：在分区扩缩容（迁移）过程中，保证消息/请求不会丢失、重复或乱序。常用“新旧分区并行+流量逐步切换”策略，先让新分区和旧分区都可用，逐步将流量导向新分区，确认无误后再下线旧分区。
   - 触发时机：分区表变更后立即开始，直到迁移完成。
   - 结果：流量平滑切换，系统无感知迁移。

### 4. Kafka 消息在分区扩缩容过程中的处理机制

- **分区扩容**：Kafka 支持动态增加 topic 分区数。扩容后，原有消息不会迁移，新消息根据分区路由策略（如 hash key）路由到新分区。老 key 顺序不受影响，消费者组自动感知分区变化并 Rebalance。
- **分区收缩**：Kafka 不支持直接减少分区数，通常通过新 topic+数据迁移实现。迁移期间采用“新旧 topic 并行+流量切换+数据补偿”策略，保证消息一致性和顺序性。
- **迁移期间消息处理**：同一个 key 的消息可能同时存在于新旧分区。需保证新旧分区消息同步（如双写、补偿、幂等去重），切流完成后新消息只写新分区，旧分区只处理历史消息，最终下线。
- **分区表多对多映射**：迁移期间，分区元数据支持 symbol 属于新旧分区，路由层和消费端需支持多分区路由和补偿。
- **顺序与一致性保障**：通过 key 路由、消息唯一ID、幂等消费等机制，保证迁移期间消息顺序和一致性。

> 该机制借鉴了 Kafka/Redis 等分布式系统的分区弹性扩缩容与迁移实践，适用于高并发消息队列和撮合系统。

### 5. 高可用与弹性
- 分区变更过程不中断服务，worker 自动感知并切换。
- 支持幂等和重试机制，确保消息不丢失、不重复。

### 6. 典型流程举例
- 初始4个分区，分别处理4个 symbol。
- symbol A 交易量激增，系统自动为其扩展新分区，A 独立由多个 worker 处理。
- symbol B/C/D 交易量下降，合并到同一分区，释放资源。

---
本设计要求为交易系统选型和集成消息队列提供参考，具体实现可结合 Kafka、RocketMQ 等主流产品文档进一步细化。
